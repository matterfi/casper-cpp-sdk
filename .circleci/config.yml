version: 2.1

configuration:
  - xcode_version: &xcode_version 13.4.1
  - ubuntu_version: &ubuntu_version ubuntu-2004:current
  - cache_vcpkg_lin: &cache_vcpkg_lin cache_vcpkg_lin-v1-{{ checksum "~/project/vcpkg/vcpkg.txt" }}

parameters:
  docker-image-casper-cpp-sdk:
    default: "polishcode/matterfi-casper-cpp-sdk-ubuntu:1"
    type: string
  path_vcpkg_bin_lin:
    default: "/home/circleci/vcpkg-binaries"
    type: string

executors:
  executor_macos:
    macos:
      xcode: *xcode_version
    resource_class: macos.x86.medium.gen2
  executor_ubuntu_large:
    machine:
      image: *ubuntu_version
    resource_class: xlarge
  executor_ubuntu_small:
    machine:
      image: *ubuntu_version
    resource_class: medium
      
commands:
  cmd_lin_prepare_env:
    description: "command to prepare basic build env"
    parameters:
      docker-image:
        type: string
    steps:
      #- run:
      #    name: "pull docker image"
      #    command: docker pull <<parameters.docker-image>>
      - checkout
  cmd_lin_build_vcpkg:
    description: "command to build vcpkg deps"
    parameters:
      docker-image:
        type: string
    steps:
      #- restore_cache:
      #    name: "restore cache vcpkg binaries"
      #    key: *cache_vcpkg_lin
      - run:
          name: "configure vcpkg & build deps"
          no_output_timeout: 40m
          working_directory: "~/"
          command: |
            if [ ! -d <<pipeline.parameters.path_vcpkg_bin_lin>> ]; then

              echo "vcpkg-binaries not present, building..."
              mkdir <<pipeline.parameters.path_vcpkg_bin_lin>>
              
              git clone git@github.com:microsoft/vcpkg.git
              cd vcpkg
              git checkout 2022.08.15

              ./bootstrap-vcpkg.sh -disableMetrics
              ./vcpkg install @~/project/vcpkg/vcpkg.txt --triplet=x64-linux --clean-after-build
              ./vcpkg export @~/project/vcpkg/vcpkg.txt --raw --triplet=x64-linux --output-dir=/home/circleci --output=vcpkg-binaries
            else
              echo "vcpkg-binaries restored from cache, skipping build :)"
            fi
      - save_cache:
          name: "save cache vcpkg binaries"
          key: *cache_vcpkg_lin
          paths:
            - <<pipeline.parameters.path_vcpkg_bin_lin>>
jobs:
  build-linux:
    parameters:
      docker-image:
        type: string
    executor: executor_ubuntu_small
    steps:
      - cmd_lin_prepare_env:
          docker-image: <<parameters.docker-image>>
      - cmd_lin_build_vcpkg:
          docker-image: <<parameters.docker-image>>

workflows:
  casper-cpp-sdk-linux:
    when: true
    jobs:
      - build-linux:
          name: build & test on linux
          docker-image: <<pipeline.parameters.docker-image-casper-cpp-sdk>>